{% extends 'ecadmin/base.html' %}
{% load widget_tweaks %}
{% block title %}
    <h3>New Product</h3>
    <div class="d-flex gap-2 align-items-center">
        <a href="{% url 'dashboard.product' %}" class="btn btn-secondary">Cancel</a>
        <button form="new-product-frm" type="submit" class="btn btn-outline-primary">Save</button>
    </div>
{% endblock %}

{% block styles %}
    <style>
        .image-card{
            width: 80px;
            height: 80px;
            background: #c0c1c2;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            background-position: center;
            background-repeat: no-repeat;
            background-size: cover;
            position: relative;
            &:hover{
                &:has(.remove-btn){
                    opacity: 1;
                }
                opacity: 0.7;
            }
            & > .remove-btn{
                position: absolute;
                top: -15px;
                right: -15px;
                outline: none;
                border: none;
                background: transparent;
                cursor: pointer;

                & > svg{
                    height: 30px;
                }
            }

            & > svg{
                height: 45px;
            }
        }

        .feature-button{
            position: absolute;
            top: 103%;
            left: 50%;
            outline: none;
            border: none;
            background: transparent;
            cursor: pointer;

            transform: translateX(-50%);

            & > svg{
                height: 20px;
            }
        }
    </style>
{% endblock %}

{% block content %}
<div class="col-12 row" id="app">
    <div class="col-12">
        {# Start Success Message #}
        <div v-if="success_message != ''" class="alert alert-success alert-dismissible fade show" role="alert">
          [[success_message]]
          <button @click="success_message=''" type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {# End Success Message #}
    </div>
    <div class="col-12">
        <form @submit.prevent="onSubmit" id="new-product-frm" method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="row">
                {# Start Left Side #}
                <div class="col-6">
                    {# Start Product Name #}
                    <div class="mb-3">
                        <label for="productName" class="form-label">Product Name:</label>
                        <input
                                v-model="form_data.name"
                                type="text"
                                class="form-control"
                                :class="{'is-invalid': errors.name != ''}"
                                id="productName"
                                placeholder="Enter Product Name"
                        >
                        <div v-if="errors.name != ''" id="validationServer03Feedback" class="invalid-feedback">
                            [[errors.name]]
                        </div>
                    </div>
                    {# End Product Name #}

                    {# Start Product Quantity #}
                    <div class="mb-3">
                        <label for="productQuantity" class="form-label">Quantity:</label>
                        <input
                                v-model="form_data.quantity"
                                type="number"
                                class="form-control"
                                min="0"
                                :class="{'is-invalid': errors.quantity != ''}"
                                id="productQuantity"
                                placeholder="Enter Product Quantity"
                        >
                        <div v-if="errors.quantity != ''" id="validationServer03Feedback" class="invalid-feedback">
                            [[errors.quantity]]
                        </div>
                    </div>
                    {# End Product Quantity #}

                    {# Start Product Category #}
                    <div class="mb-3">
                        <label for="category" class="form-label">Category:</label>
                        <select v-model="form_data.category_id" id="category" class="form-select" :class="{'is-invalid': errors.category != ''}">
                          <option value="" selected disabled>Choose Category</option>
                          <option v-for="item in category_list" :key="'category_id'+item.id" :value="item.id">[[item.name]]</option>
                        </select>
                         <div v-if="errors.category != ''" id="validationServer03Feedback" class="invalid-feedback">
                            [[errors.category]]
                        </div>
                    </div>
                    {# End Product Category #}
                </div>
                {# End Left Side #}

                {# Start Right Side #}
                <div class="col-6">
                    {# Start Status #}
                    <div class="mb-3">
                        <label for="status" class="form-label">Status:</label>
                        <select v-model="form_data.status" id="status" class="form-select">
                          <option value="" selected disabled>Choose Status</option>
                          <option value="0">Inactive</option>
                            <option value="1">Active</option>
                        </select>
                    </div>
                    {# End Status #}

                    {# Start Product Price #}
                    <div class="mb-3">
                        <label for="productPrice" class="form-label">Price:</label>
                        <input
                                v-model="form_data.price"
                                type="number"
                                step="0.01"
                                class="form-control"
                                min="0"
                                :class="{'is-invalid': errors.price != ''}"
                                id="productPrice"
                                placeholder="Enter Product Price"
                        >
                        <div v-if="errors.price != ''" id="validationServer03Feedback" class="invalid-feedback">
                            [[errors.price]]
                        </div>
                    </div>
                    {# End Product Price #}

                    {# Start Product Brand #}
                    <div class="mb-3">
                        <label for="brand" class="form-label">Brand:</label>
                        <select v-model="form_data.brand_id" id="brand" class="form-select" :class="{'is-invalid': errors.brand != ''}">
                          <option value="" selected disabled>Choose Brand</option>
                          <option v-for="item in brand_list" :key="'category_id'+item.id" :value="item.id">[[item.name]]</option>
                        </select>
                        <div v-if="errors.brand != ''" id="validationServer03Feedback" class="invalid-feedback">
                            [[errors.brand]]
                        </div>
                    </div>
                    {# End Product Brand #}
                </div>
                {# End Left Side #}
            </div>

            {# Start Product Images #}
            <div class="mb-3">
                <label class="form-label">Product Images:</label>
                <div
                    style="min-height: 150px;
                    background-color: #dee2e6"
                    class="rounded d-flex align-items-center justify-content-start gap-3 px-4 is-invalid"
                    :class="{'border border-danger': errors.image != ''}"
                >
                    <div
                        v-for="(item, index) in form_data.images_list"
                        :key="item.id"
                        class="image-card"
                        :style="{'background-image': 'url('+generateImageURL(item.file)+')'}"
                    >
                        <button @click="onRemoveImage(item.id)" class="remove-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="red" class="size-6">
                              <path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25Zm-1.72 6.97a.75.75 0 1 0-1.06 1.06L10.94 12l-1.72 1.72a.75.75 0 1 0 1.06 1.06L12 13.06l1.72 1.72a.75.75 0 1 0 1.06-1.06L13.06 12l1.72-1.72a.75.75 0 1 0-1.06-1.06L12 10.94l-1.72-1.72Z" clip-rule="evenodd" />
                            </svg>
                        </button>
                        
                        <!-- Start Feature Button -->
                        <button type="button" @click="onSetAsFeature(item.id)" class="feature-button">
                            <svg v-if="!item.is_feature" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 0 1 1.04 0l2.125 5.111a.563.563 0 0 0 .475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 0 0-.182.557l1.285 5.385a.562.562 0 0 1-.84.61l-4.725-2.885a.562.562 0 0 0-.586 0L6.982 20.54a.562.562 0 0 1-.84-.61l1.285-5.386a.562.562 0 0 0-.182-.557l-4.204-3.602a.562.562 0 0 1 .321-.988l5.518-.442a.563.563 0 0 0 .475-.345L11.48 3.5Z" />
                            </svg>
                            <svg style="color: #ffc107;" v-else xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-6">
                                <path fill-rule="evenodd" d="M10.788 3.21c.448-1.077 1.976-1.077 2.424 0l2.082 5.006 5.404.434c1.164.093 1.636 1.545.749 2.305l-4.117 3.527 1.257 5.273c.271 1.136-.964 2.033-1.96 1.425L12 18.354 7.373 21.18c-.996.608-2.231-.29-1.96-1.425l1.257-5.273-4.117-3.527c-.887-.76-.415-2.212.749-2.305l5.404-.434 2.082-5.005Z" clip-rule="evenodd" />
                            </svg>

                        </button>
                        <!-- End Feature Button -->
                    </div>
                    <div>
                        <label class="image-card" for="image-file">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v6m3-3H9m12 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                            </svg>
                        </label>
                        <input @change="onUploadFile" type="file" style="display: none;visibility: hidden" id="image-file" accept=".jpg,.png,.jpeg,.webp"/>
                    </div>
                </div>
                <div v-if="errors.image != ''" id="validationServer03Feedback" class="invalid-feedback">
                    [[errors.image]]
                </div>
            </div>
            {# End Product Images #}

            {# Start Description #}
            <div class="mb-3">
                <label for="description" class="form-label">Description:</label>
                <textarea v-model="form_data.description" name="description" cols="40" rows="18" class="form-control mt-2" placeholder="(Optional)" :class="{'is-invalid': errors.description != ''}" id="description"></textarea>
                <div v-if="errors.description != ''" id="validationServer03Feedback" class="invalid-feedback">
                    [[errors.description]]
                </div>
            </div>
            {# End Description #}
        </form>
    </div>
</div>
{% endblock %}

{% block script %}
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script>
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');
    </script>
    <script>
      const { createApp } = Vue

      createApp({
        delimiters: ['[[', ']]'],
        created(){
            this.category_list = JSON.parse("{{ category_list|escapejs }}")
            this.brand_list = JSON.parse("{{ brand_list|escapejs }}")
            this.category_list = this.category_list.map( category => {
                let new_category = {
                    "id":category._id["$oid"],
                    "name":category.name,
                }
                return new_category
            })

            this.brand_list = this.brand_list.map( brand => {
                let new_brand = {
                    "id":brand._id["$oid"],
                    "name":brand.name,
                }
                return new_brand
            })
        },
        data() {
          return {
            category_list:[],
            brand_list:[],
            success_message:"",
            form_data:{
                name:"",
                description:"",
                images_list:[],
                quantity:0,
                price:0,
                status:1,
                category_id:"",
                brand_id:"",
            },
            errors:{
                name:"",
                description:"",
                image:"",
                quantity:"",
                price:"",
                category:"",
                brand:"",
            }
          }
        },
        methods: {
            onUploadFile(e){
                const file = e.target.files[0];
                const allowedExtensions = ["image/jpg", "image/png", "image/jpeg", "image/webp"];
                if(file){
                    const {type} = file
                    if(!allowedExtensions.includes(type)){
                        alert("Please choose a file with extensions (jpg,jpeg,png,webp).")
                        return
                    }
                    this.form_data.images_list.push({
                        id:file.name,
                        file:file
                    })
                    document.querySelector("#image-file").value = "";
                }
            },
            onSubmit(evt){
                $.LoadingOverlay("show");
                evt.preventDefault()
                this.clearError()
                const formData = new FormData()
                formData.append("name", this.form_data.name)
                formData.append("category_id",this.form_data.category_id)
                formData.append("brand_id",this.form_data.brand_id)
                formData.append("quantity",this.form_data.quantity)
                formData.append("price",this.form_data.price)
                formData.append("status",this.form_data.status)
                formData.append("description",this.form_data.description)
                
                for(let i=0;i<this.form_data.images_list.length;i++){
                    formData.append("image",this.form_data.images_list[i].file)
                    if(this.form_data.images_list[i].is_feature){
                        formData.append("feature_image",this.form_data.images_list[i].file.name)
                    }
                }

                axios.post("{% url 'dashboard.product.create' %}",formData,{
                    method:"POST",
                    headers:{'X-CSRFToken': csrftoken},
                }).then(rp => {
                    if(rp.status === 201){
                        setTimeout(function(){
                            $.LoadingOverlay("hide");
                        }, 1300);
                        this.clearForm()
                        this.success_message = rp.data.message;
                        
                    }
                }).catch(err=>{
                    setTimeout(function(){
                        $.LoadingOverlay("hide");
                    }, 1300);
                    const keys = []
                    for(let i=0;i<err.response.data.data.length;i++){
                        let key = Object.keys(err.response.data.data[i])[0]
                        let message = err.response.data.data[i][key]
                        this.errors[key] = message
                    }
                })

                
            },
            clearForm(){
                this.form_data = {
                    name:"",
                    description:"",
                    images_list:[],
                    quantity:0,
                    price:0,
                    status:1,
                    category_id:"",
                    brand_id:"",
                }
                this.clearError()
               
            },
            clearError(){
                 this.errors = {
                    name:"",
                    description:"",
                    image:"",
                    quantity:"",
                    price:"",
                    category:"",
                    brand:"",
                }
            },
            onRemoveImage(id){
                const index = this.form_data.images_list.findIndex(image => image.id === id)
                this.form_data.images_list.splice(index,1)
            },
            onSetAsFeature(id){
                const item = this.form_data.images_list.find(image => image.id === id)
                item.is_feature = item.is_feature ? false : true

                // set other images feature as false
                this.form_data.images_list.map(image => {
                    if(image.id !== id && image.is_feature){
                        image.is_feature = false
                    }
                })
                
            },
            generateImageURL(file){
                return URL.createObjectURL(file);
            }
        }
      }).mount('#app')
    </script>
{% endblock %}
